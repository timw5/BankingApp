@page
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@model BankingApp.Pages.Account.AccountModel

@{
    ViewData["Title"] = "Account";
}
<style>
    .linkto:active, .linkto:hover{
        -webkit-text-stroke:thin!important;
        -webkit-text-stroke-color:cornflowerblue!important;
        -webkit-text-size-adjust:!important;
    }
    .hidden {
        display: @Model.hidden!important;
    }
</style>

    <div class="container shadow-lg border rounded-3">
        <div class="container mx-auto mt-2 w-100">
            <h1 class="text-center my-4">Welcome @Model._User.Username</h1>
            <div class="row container mx-auto w-100 ">
                @foreach (var item in Model._Account)
                {
                    <div class="col-md-3 m-4 p-4 border rounded-2 shadow-lg mx-auto"  title="View Transactions" id="@item.ID" >
                        <div class="h3 fw-bold mb-2  linkto  text-center" :hover Onclick="GetTransactions" style="cursor: pointer" >@item.Type  </div>
                            <hr/>
                            <div class="col-sm-2 w-100 fw-bold text-center">
                                Balance:
                            </div>
                            <div class="col-sm-2 w-100 text-center">
                                @item.BalanceToString()
                            </div>
                        <div class="col-sm-2 w-100 text-center">
                            <button class="btn btn-success mt-4 mx-auto justify-content-center" id="#AddFunds" type="button">Add Funds</button> @*add funds button*@
                        </div>
                    </div>
                }@*End Foreach*@
            </div>
            <div class="container w-100 text-center">
                <button class= "btn btn-primary m-4 hidden" id="newacnt"   @*asp-page="/Account/Home" asp-page-handler="AddNewAccount"*@ > Add new Account</button>
                @Html.AntiForgeryToken() @*Added anti-forgery token for ajax call*@

                <a href="#" class="btn btn-primary m-4" type="button"  id="TransferFunds">Transfer Funds </a>
            </div>
        </div>
    </div>

@section scripts
{
    <script src="~/lib/limonte-sweetalert2/sweetalert2.all.js"></script>
    <script type="text/javascript">
        //Below is the method to add a new account
        //We use AJAX, and an asynchronous POST request to send the selected option from sweet alert
        //We then use the OnPostAddNewAccount method that can be found in our Home.cshtml.cs page
        $("#newacnt").click(() => 
        {
            console.log("in newaccount function");
            (async () => 
            {

                const inputOptions = new Promise((resolve) => 
                {
                    setTimeout(() => 
                    {
                        resolve
                        ({
                            'Savings': 'Savings',
                            'Investment': 'Investment',
                            'Checking': 'Checking'
                        })//end resolve

                    }, 1000)//end setTimeout

                })//end inputOptions

                const { value: acntType } = 
                await Swal.fire
                ({
                    title: "Which type of account?",
                    input: "radio",
                    showCancelButton: true,
                    showConfirmButton: true,
                    inputOptions: inputOptions,
                    inputValidator: (value) => 
                    {
                        if (!value) 
                        {
                            return "You must select an account";
                        }//end if(!value)

                    }//end input validator

                })//end await Swal.fire


                if (acntType) 
                {
                    const URL = './Home?handler=AddNewAccount';

                    $.ajax
                    ({
                        type: 'POST',
                        url: URL,
                        async: true,
                        beforeSend: function(xhr) 
                        {
                            xhr.setRequestHeader("XSRF-TOKEN", $('input:hidden[name="__RequestVerificationToken"]').val());
                        },
                        contentType: "application/json; charset=utf-8",
                        dataType: 'json',
                        data: JSON.stringify(acntType),
                        success: function(data) 
                        {
                            location.reload();
                        },
                        error: function(error) 
                        {
                            console.log(`Error ${error}`);
                        }//end error

                    })//end ajax
                    .then//ajax then
                    (
                        Swal.fire
                        (
                            'Account Created Succesfully',
                            '',
                            'success',

                        )
                        .then((result) => //Swal.fire.then
                        {
                            if (result.isConfirmed) 
                            {
                                window.location.reload();//reload to get database changes to the page

                            }//end if(result.isConfirmed)

                        })//end swal fire

                    )//end ajax.then

                }//end if(acntType)

            })();//end async

        });//end function

    </script> @*End Script*@

}@*End Section Script*@




  
